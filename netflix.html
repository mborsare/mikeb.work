<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Netflix US AtoZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #000000;
      --text: #c0c0c0;
      --stamp: #888888;
      --seal: #eaffea;
      --btn-fill: color-mix(in hsl, var(--bg), var(--seal) 20%);
    }

    html {
      font-size: 14px;
    }

    @font-face {
      font-family: 'ComicMono';
      src: url('/fonts/ComicMono-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'ComicMono', monospace;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      max-width: 72rem;
      width: 100%;
      padding: 1.5rem;
      text-align: center;
    }

    h1 {
      color: var(--seal);
      letter-spacing: .15em;
      margin: 0 0 .25rem 0;
      font-size: 1.6rem;
    }

    .meta {
      opacity: .7;
      font-size: .85rem;
      margin: 0 0 1.25rem 0;
    }

    .controls {
      display: flex;
      align-items: center;
      margin: 0 auto 1rem auto;
      max-width: 64rem;
    }

    input[type="text"] {
      background: transparent;
      border: 2px solid var(--stamp);
      color: var(--text);
      padding: .75rem .9rem;
      border-radius: .9rem;
      font-family: inherit;
      width: 100%;
      outline: none;
    }

    .filters {
      display: flex;
      margin: 1em;
    }

    #count {
      opacity: .75;
      font-size: .85rem;
      margin: .5rem 0 0 0;
    }

    .catalog {
      margin-top: 1.25rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr));
      gap: .5rem;
      text-align: left;
    }

    .item {
      display: grid;
      grid-template-columns: 3.5rem 1fr;
      gap: .6rem;
      padding: .55rem .75rem;
      border: 1px dotted color-mix(in srgb, var(--stamp), transparent 20%);
      border-radius: .85rem;
      text-decoration: none;
      color: inherit;
    }

    .cover {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      border-radius: .4rem;
      background: #111;
    }

    .title {
      color: var(--seal);
      line-height: 1.25;
    }

    .sub {
      opacity: .65;
      margin-top: .2rem;
      font-size: .85rem;
    }

    /* NEW: synopsis */
    .synopsis {
      margin-top: .35rem;
      font-size: .8rem;
      line-height: 1.35;
      opacity: .6;
    }

    .pill {
      display: inline-block;
      padding: .05rem .45rem;
      border: 1px solid color-mix(in srgb, var(--stamp), transparent 15%);
      border-radius: 999px;
      margin-left: .35rem;
      font-size: .75rem;
      opacity: .85;
    }
  </style>
</head>

<body>
  <div class="container">
    <nav style="padding: 5em; text-align: center;">
      <a href="/" style="color: var(--seal)">Back</a>
    </nav>

    <h1>NETFLIX US A–Z</h1>
    <div class="meta" id="snapshot">Fixing Netflix, one sec…</div>

    <div class="controls">
      <input id="search" type="text" placeholder="Search titles…" oninput="applyFilters()" autocomplete="off" />
      <div class="filters">
        <label><input type="checkbox" id="filter-movie" checked onchange="applyFilters()" /> Movies</label>
        <label><input type="checkbox" id="filter-series" checked onchange="applyFilters()" /> Series</label>
      </div>
    </div>

    <div id="count"></div>
    <div class="catalog" id="catalog"></div>
  </div>

  <script>
    const DATA_URL = 'https://netflix.mborsare.workers.dev/';

    const DUMMY_TITLES = [
      {
        title: 'Arrival',
        type: 'movie',
        year: 2016,
        rating: 'PG-13',
        netflix_id: null,
        img: null,
        synopsis: ''
      }
    ];

    let allTitles = [];
    let usingDummy = false;

    /* UPDATED: preserve img + synopsis */
    function normalizeFromWorker(results) {
      return results.map(item => ({
        title: item.title,
        type: item.title_type === 'movie' ? 'movie' : 'series',
        year: item.title_date || item.year || 'N/A',
        rating: item.rating || '',
        netflix_id: item.netflix_id,
        img: item.img || null,
        synopsis: item.synopsis || ''
      }));
    }

    async function loadCatalog() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error();

        const data = await res.json();
        if (!Array.isArray(data.results) || data.results.length === 0) throw new Error();

        usingDummy = false;
        allTitles = normalizeFromWorker(data.results);
        document.getElementById('snapshot').textContent =
          `Snapshot: ${data.day} · ${allTitles.length} titles`;
        applyFilters();

      } catch {
        usingDummy = true;
        allTitles = DUMMY_TITLES.slice();
        document.getElementById('snapshot').textContent =
          'Snapshot: dummy data';
        applyFilters();
      }
    }

    function applyFilters() {
      const q = document.getElementById('search').value.toLowerCase();
      const showMovies = document.getElementById('filter-movie').checked;
      const showSeries = document.getElementById('filter-series').checked;

      const filtered = allTitles.filter(t => {
        if (t.type === 'movie' && !showMovies) return false;
        if (t.type === 'series' && !showSeries) return false;
        if (q && !t.title.toLowerCase().includes(q)) return false;
        return true;
      });

      document.getElementById('count').textContent =
        `${filtered.length} titles${usingDummy ? ' (dummy)' : ''}`;

      document.getElementById('catalog').innerHTML = filtered.map(t => {
        const cover = t.img
          ? `<img class="cover" src="${t.img}" loading="lazy" alt="">`
          : '';

        const synopsis = t.synopsis
          ? `<div class="synopsis">${escapeHtml(t.synopsis)}</div>`
          : '';

        return `
          <a class="item"
             href="${t.netflix_id ? `https://www.netflix.com/watch/${t.netflix_id}` : '#'}"
             target="_blank"
             rel="noopener noreferrer">
            ${cover}
            <div>
              <div class="title">${escapeHtml(t.title)}</div>
              <div class="sub">${t.year} <span class="pill">${t.type}</span></div>
              ${synopsis}
            </div>
          </a>
        `;
      }).join('');
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }

    loadCatalog();
  </script>
</body>

</html>